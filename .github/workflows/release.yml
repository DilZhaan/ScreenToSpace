name: Release - Create and Publish

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gettext glib-2.0-dev zip jq
    
    - name: Get version from tag
      id: get_version
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        VERSION=${TAG#v}
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Release version: $VERSION"
    
    - name: Verify version matches metadata
      run: |
        METADATA_VERSION=$(jq -r '.version' src/metadata.json)
        TAG_VERSION="${{ steps.get_version.outputs.version }}"
        
        # Extract major version if tag has minor/patch
        TAG_MAJOR=$(echo $TAG_VERSION | cut -d. -f1)
        
        if [ "$METADATA_VERSION" != "$TAG_MAJOR" ]; then
          echo "‚ö† Warning: metadata.json version ($METADATA_VERSION) differs from tag ($TAG_MAJOR)"
          echo "Updating metadata.json..."
          jq ".version = $TAG_MAJOR" src/metadata.json > src/metadata.json.tmp
          mv src/metadata.json.tmp src/metadata.json
        fi
    
    - name: Compile schemas
      run: |
        cd src/schemas
        glib-compile-schemas .
    
    - name: Build extension package
      run: |
        chmod +x scripts/makezip.sh
        ./scripts/makezip.sh
    
    - name: Generate changelog
      id: changelog
      run: |
        if [ -f CHANGELOG.md ]; then
          # Extract changelog for this version
          awk '/^## \['${{ steps.get_version.outputs.version }}'\]/,/^## \[/{if(/^## \[/ && !/^## \['${{ steps.get_version.outputs.version }}'\]/)exit;print}' CHANGELOG.md > release_notes.md
          if [ ! -s release_notes.md ]; then
            echo "Release ${{ steps.get_version.outputs.tag }}" > release_notes.md
          fi
        else
          echo "Release ${{ steps.get_version.outputs.tag }}" > release_notes.md
        fi
        
        echo "Release notes:"
        cat release_notes.md
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: build/screentospace@dilzhan.dev.zip
        body_path: release_notes.md
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload package as artifact
      uses: actions/upload-artifact@v4
      with:
        name: release-package-${{ steps.get_version.outputs.version }}
        path: build/screentospace@dilzhan.dev.zip
        retention-days: 90

  publish-to-ego:
    name: Publish to GNOME Extensions
    runs-on: ubuntu-latest
    needs: create-release
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Get version from tag
      id: get_version
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        VERSION=${TAG#v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
    
    - name: Package and Upload to extensions.gnome.org
      uses: murar8/gnome-extensions-action@0.1.0
      with:
        source-dir: ./src
        username: ${{ secrets.EGO_USERNAME }}
        password: ${{ secrets.EGO_PASSWORD }}
        accept-tos: true
        force: false
      continue-on-error: true
      id: ego_upload
    
    - name: Upload Status
      run: |
        if [ "${{ steps.ego_upload.outcome }}" == "success" ]; then
          echo "‚úÖ Successfully uploaded to extensions.gnome.org"
          echo "Extension will be reviewed by GNOME Extensions team"
        else
          echo "‚ö†Ô∏è Upload to extensions.gnome.org failed or was skipped"
          echo "Please upload manually to: https://extensions.gnome.org/upload/"
          echo "Package location: ${{ steps.ego_upload.outputs.zip-file }}"
          echo ""
          echo "Common reasons for failure:"
          echo "  ‚Ä¢ Credentials not configured (EGO_USERNAME/EGO_PASSWORD)"
          echo "  ‚Ä¢ Extension not yet registered on extensions.gnome.org"
          echo "  ‚Ä¢ Version already exists"
          echo "  ‚Ä¢ TOS not accepted"
        fi
    
    - name: Manual Upload Instructions
      if: steps.ego_upload.outcome != 'success'
      run: |
        echo "üìã Manual Upload Instructions:"
        echo "1. Download the extension package from GitHub Releases"
        echo "2. Go to: https://extensions.gnome.org/upload/"
        echo "3. Upload: build/screentospace@dilzhan.dev.zip"
        echo "4. Fill in extension details and submit for review"
        echo ""
        echo "See PUBLISHING.md for detailed instructions"
