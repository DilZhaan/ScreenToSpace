name: PR - Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-validation:
    name: Pull Request Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gettext glib-2.0-dev libxml2-utils zip jq
    
    - name: Check commit messages
      run: |
        echo "Checking commit message format..."
        # Check if commits follow conventional commit format
        COMMITS=$(git log --format=%s origin/${{ github.base_ref }}..HEAD)
        echo "$COMMITS" | while read -r msg; do
          if [[ $msg =~ ^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?:\ .+ ]]; then
            echo "âœ“ $msg"
          else
            echo "âš  Non-conventional format: $msg"
          fi
        done
    
    - name: Run all validations
      run: |
        echo "Running JavaScript validation..."
        for file in src/*.js; do
          node --check "$file"
        done
        
        echo "Running JSON validation..."
        cat src/metadata.json | jq . > /dev/null
        
        echo "Running XML validation..."
        xmllint --noout src/schemas/*.xml
        
        echo "Compiling schemas..."
        cd src/schemas
        glib-compile-schemas .
    
    - name: Build test
      run: |
        chmod +x scripts/makezip.sh
        ./scripts/makezip.sh
        
        if [ -f build/screentospace@dilzhan.dev.zip ]; then
          echo "âœ“ Build successful"
          ls -lh build/screentospace@dilzhan.dev.zip
        else
          echo "âœ— Build failed"
          exit 1
        fi
    
    - name: Check for TODO/FIXME
      run: |
        echo "Checking for TODO/FIXME comments..."
        if grep -r "TODO\|FIXME" src/*.js; then
          echo "âš  Found TODO/FIXME comments"
        else
          echo "âœ“ No TODO/FIXME comments found"
        fi
    
    - name: Size check
      run: |
        SIZE=$(stat -f%z build/screentospace@dilzhan.dev.zip 2>/dev/null || stat -c%s build/screentospace@dilzhan.dev.zip)
        SIZE_KB=$((SIZE / 1024))
        echo "Package size: ${SIZE_KB}KB"
        
        if [ $SIZE_KB -gt 100 ]; then
          echo "âš  Warning: Package is larger than 100KB"
        else
          echo "âœ“ Package size is acceptable"
        fi
    
    - name: Comment on PR
      uses: actions/github-script@v7
      if: always()
      with:
        script: |
          const fs = require('fs');
          const size = fs.statSync('build/screentospace@dilzhan.dev.zip').size;
          const sizeKB = Math.round(size / 1024);
          
          const comment = `## ğŸ¤– PR Validation Results
          
          âœ… All checks passed!
          
          ğŸ“¦ **Package Size**: ${sizeKB}KB
          ğŸ—ï¸ **Build**: Success
          âœ… **Validations**: Passed
          
          The extension package is ready for review.`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
